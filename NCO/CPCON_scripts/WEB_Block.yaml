---
- name: Block HTTP/HTTPS traffic for 10.0.2.0/24 subnet
  hosts: 10.0.2.20
  remote_user: vagrant
  become: true

  pre_tasks:
    - name: Wait for SSH to be available
      wait_for:
        port: 22
        host: "{{ inventory_hostname }}"
        timeout: 60
        state: started
      register: ssh_wait
      retries: 5
      delay: 10
      until: ssh_wait is succeeded

  tasks:
    - name: Flush iptables rules
      iptables:
        flush: yes

    - name: Block outbound HTTP from 10.0.2.0/24 to the internet
      iptables:
        chain: FORWARD
        protocol: tcp
        source: 10.0.2.0/24
        destination_port: "80"
        jump: DROP
        rule_num: "1"

    - name: Block outbound HTTPS from 10.0.2.0/24 to the internet
      iptables:
        chain: FORWARD
        protocol: tcp
        source: 10.0.2.0/24
        destination_port: "443"
        jump: DROP
        rule_num: "2"

    - name: Block inbound HTTP from internet to 10.0.2.0/24
      iptables:
        chain: FORWARD
        protocol: tcp
        destination: 10.0.2.0/24
        destination_port: "80"
        jump: DROP
        rule_num: "3"

    - name: Block inbound HTTPS from internet to 10.0.2.0/24
      iptables:
        chain: FORWARD
        protocol: tcp
        destination: 10.0.2.0/24
        destination_port: "443"
        jump: DROP
        rule_num: "4"
