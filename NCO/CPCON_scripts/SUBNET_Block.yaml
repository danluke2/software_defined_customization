- name: Allow only SSH from 10.0.8.22
  hosts: 10.0.2.20
  become: true
  remote_user: vagrant

  pre_tasks:
    - name: Wait for SSH to be available
      wait_for:
        port: 22
        host: "{{ inventory_hostname }}"
        timeout: 60
        state: started
      register: ssh_wait
      retries: 5
      delay: 10
      until: ssh_wait is succeeded

  tasks:
    - name: Flush existing rules
      iptables:
        flush: yes

    - name: Set default FORWARD policy to DROP
      iptables:
        chain: FORWARD
        policy: DROP
        state: present

    - name: Explicitly drop all forwarded UDP traffic
      iptables:
        chain: FORWARD
        protocol: udp
        jump: DROP
        state: present

    - name: Allow SSH from 10.0.8.22 to port 22
      iptables:
        chain: INPUT
        protocol: tcp
        source: 10.0.8.22
        destination_port: "22"
        jump: ACCEPT
        state: present

    - name: Allow SSH response to 10.0.8.22
      iptables:
        chain: OUTPUT
        protocol: tcp
        destination: 10.0.8.22
        source_port: "22"
        jump: ACCEPT
        state: present

    - name: Set default OUTPUT policy to DROP
      iptables:
        chain: OUTPUT
        policy: DROP

    - name: Set default INPUT policy to DROP
      iptables:
        chain: INPUT
        policy: DROP

    - name: Drop all loopback traffic
      iptables:
        chain: INPUT
        in_interface: lo
        jump: DROP
        state: present

    # - name: Explicitly drop all incoming UDP traffic
    #   iptables:
    #     chain: INPUT
    #     protocol: udp
    #     jump: DROP
    #     state: present

    # - name: Explicitly drop all outgoing UDP traffic
    #   iptables:
    #     chain: OUTPUT
    #     protocol: udp
    #     jump: DROP
    #     state: present

    # - name: Allow established INPUT connections
    #   iptables:
    #     chain: INPUT
    #     ctstate: ESTABLISHED,RELATED
    #     jump: ACCEPT
    #     state: present

    # - name: Allow established OUTPUT connections
    #   iptables:
    #     chain: OUTPUT
    #     ctstate: ESTABLISHED,RELATED
    #     jump: ACCEPT
    #     state: present
